<!DOCTYPE html>
<html>
	<head>
		<title>CH3RDS</title>
		<style start="harmonic">
.harmonic{
 border-style: solid;
 border-width: 1px;
 border-color: blue;
 margin: 5px;
 width: 50px;
 height: 30px;
}
.harmonic-on{
 color: #00D000;
 background-color: #0000FF;
}
		</style end="harmonic">
		<style start="chord">
body{
 white-space: nowrap;
}
.chord{
 display: inline-block;
 vertical-align: top;
}
.chord-separator{
 border-style: solid;
 border-width: 1px;
 border-color: white;
 margin: 5px;
 width: 50px;
 height: 20px;
}
.chord-board{
 margin: 5px;
 width: 50px;
 height: 100px;
}
.chord-button{
 border-style: solid;
 border-width: 1px;
 border-color: green;
 width: 50px;
 height: 100px;
}
.chord-sharp .chord-button{
 background-color: #C0C0C0;
 height: 50px;
}
.chord-on{
 color: #A0A0FF;
 background-color: #00FF00;
}
.chord-sharp .chord-on{
 color: #A0A0FF;
 background-color: #00FF00;
}
.chord-append{
 border-style: solid;
 border-width: 1px;
 border-color: black;
 margin: 5px;
 width: 50px;
 height: 50px;
}
.chord-change{
 border-style: solid;
 border-width: 1px;
 border-color: black;
 margin: 5px;
 width: 50px;
 height: 50px;
}
.chord-delete{
 border-style: solid;
 border-width: 1px;
 border-color: black;
 margin: 5px;
 width: 50px;
 height: 50px;
}
.chord-select-hidden{
 display: none;
}
		</style end="chord">
	</head>
	<body>
		<script start="Gain">
function Gain(audioContext, master){
	this.audioContext = audioContext;
	this.destination = master? master.gain: audioContext.destination;
	this.gain = audioContext.createGain();
	this.gain.gain.value = 0;
	this.gain.connect(this.destination);
}
Gain.prototype.control = function(node){
	node.connect(this.gain);
};
Gain.prototype.setGain = function(value){
	this.gain.gain.value = value;
};
		</script end="Gain">
		<script start="Oscillators">
function Oscillator(audioContext, master){
	this.audioContext = audioContext;
	this.master = master;
	this.oscillator = null;
	this.shape = "sine";
	this.frequency = 440;
	this.detune = 0;
	this.gain = new Gain(audioContext, master);
}
Oscillator.prototype.setDetune = function(value){
	this.detune = value;
	if (this.oscillator){
		this.oscillator.detune.value = this.detune;
	}
};
Oscillator.prototype.setFrequency = function(value){
	this.frequency = value;
	if (this.oscillator){
		this.oscillator.frequency.value = this.frequency;
	}
};
Oscillator.prototype.setShape = function(value){
	this.shape = value;
	if (this.oscillator){
		this.oscillator.type = this.shape;
	}
};
Oscillator.prototype.setGain = function(value){
alert("1 setGain: " + value);
	if (value === 0){
		if (this.oscillator){
			this.oscillator.stop(0);
			this.gain.disconnect(this.oscillator);
			this.oscillator = null;
		}
	}
	else{
alert("2 setGain: " + value);
		this.gain.setGain(value);
alert("3 setGain: " + value);

		if (!this.oscillator){
alert("4 setGain: " + value);

			this.oscillator = audioContext.createOscillator();
alert("6 setGain: " + value);
			this.oscillator.type = this.shape;
alert("7 setGain: " + value);
			this.oscillator.frequency.value = this.frequency;
alert("8 setGain: " + value);
			this.oscillator.detune.value = this.detune;
alert("9 setGain: " + value);
			this.gain.control(this.oscillator);
alert("10 setGain: " + value);
			this.oscillator.start(0);
alert("11 setGain: " + value);
		}
	}
};
		</script end="Oscillator">
		<script start="Harmonic">
function Harmonic(audioContext, master, container, tone, octave, type, order){
	this.audioContext = audioContext;
	this.master = master;
	this.container = container;
	this.tone = tone;
	this.octave;
	this.type = type;
	this.order = order;
	this.oscillator = new Oscillator(audioContext, master);
	this.setShape("sine");
	this.setFrequency(tone, octave, type, order);
	this.setDetune(tone, octave, type, order);
	this.setLabel(type, order);
	this.on = false;
	if (order == 1 || order == 3 || order == 5){
		this.on = true;
	}
	this.div = document.createElement("DIV");
	this.div.className = "harmonic";
	this.div.appendChild(document.createTextNode(this.label));
	container.appendChild(this.div);
	if (this.on){
		this.div.className = "harmonic harmonic-on";
		this.oscillator.setGain(this.equalizer);
	}
	var harmonic = this;
	this.div.onmousedown = function(){
		if (harmonic.on){
			harmonic.oscillator.setGain(0);
			harmonic.on = false;
			harmonic.div.className = "harmonic";
		}
		else{
			harmonic.oscillator.setGain(harmonic.equalizer);
			harmonic.on = true;
			harmonic.div.className = "harmonic harmonic-on";
		}
	};
	this.div.addEventListener('touchstart', function (event){
		event.preventDefault();
		if (harmonic.on){
			harmonic.oscillator.setGain(0);
			harmonic.on = false;
			harmonic.div.className = "harmonic";
		}
		else{
			harmonic.oscillator.setGain(harmonic.equalizer);
			harmonic.on = true;
			harmonic.div.className = "harmonic harmonic-on";
		}
	}, false);
}
Harmonic.prototype.setFrequency = function(tone, octave, type, order){
	this.frequency = 440;
	this.oscillator.setFrequency(this.frequency);
}
Harmonic.prototype.setDetune = function(tone, octave, type, order){
	var detune = 0;
	var TONES = { "C": -900, "C#": -800, "D": -700, "D#": -600, "E": -500, "F": -400, "F#": -300, "G": -200, "G#": -100, "A": 0, "A#": 100, "B": 200};
	detune += TONES[tone];
	var pitch = (order - 1) % 7;
	octave += (order - 1 - pitch) / 7;
	if (type === "minor"){
		var MINOR = [0, 200, 300, 500, 700, 800, 1000];
		detune += MINOR[pitch];
	}
	else{
		var MAJOR = [0, 200, 400, 500, 700, 900, 1100];
		detune += MAJOR[pitch];
	}
	detune += octave * 1200;
	this.detune = detune;
	this.setEqualizer(this.detune);
	this.oscillator.setDetune(this.detune);
}
Harmonic.prototype.setEqualizer = function(detune){
	var equalizer = 1;
	var max = 1200 * 4;
	var min = -1200 * 2;
	if (detune > max){
		equalizer = 0;
	}
	else if (detune > min){
		equalizer = (max-detune)/(max - min);
	}
	this.equalizer = equalizer;
}
Harmonic.prototype.setShape = function(value){
	this.shape = value;
	this.oscillator.setShape(this.shape);
}
Harmonic.prototype.setLabel = function(type, order){
	var label = (order === 1)? "1st": (order === 2)? "2nd": (order === 3)? "3rd": order + "th";
	this.label = label;
}
		</script end="Harmonic">
		<script start="Chord">
function Chord(audioContext, master, container, before, tone, octave, type){
	this.audioContext = audioContext;
	this.master = master;
	this.gain = new Gain(audioContext, master);
	this.mute = 0;
	this.shape = "sine";
	this.container = container;
	this.tone = tone;
	this.octave = octave;
	this.type = type;
	this.on = false;
	this.setEqualizer(this.tone, this.octave, this.type, this.shape);
	this.whole = document.createElement("DIV");
	this.whole.className = "chord";
	if (before){
		container.insertBefore(this.whole, before);
	}
	else{
		container.appendChild(this.whole);
	}
	this.setStyle(tone, octave, type);
	this.harmonics = [];
	//debug for (var order = 17; order > 0; order--){ //debug
	for (var order = 1; order > 0; order--){ //debug
		var harmonic = new Harmonic(audioContext, this.gain, this.whole, tone, octave, type, order);
		harmonic.setShape(this.shape);
		this.harmonics.push(harmonic);
	}
	this.addSeparator();
	var board = document.createElement("DIV");
	board.className ="chord-board";
	this.div = document.createElement("DIV");
	this.div.className = "chord-button";
	this.div.appendChild(document.createTextNode(this.label));
	board.appendChild(this.div);
	this.whole.appendChild(board);
	this.setLabel(tone, octave, type);
	var chord = this;
	this.div.onmousedown = function(){
		chord.gain.setGain((1-chord.mute)*chord.equalizer);
		chord.on = true;
		chord.div.className = "chord-button chord-on";
	};
	this.div.onmouseup = function(){
		chord.gain.setGain(0);
		chord.on = false;
		chord.div.className = "chord-button";
	};
	this.div.addEventListener('touchstart', function(event){
		event.preventDefault();
		chord.gain.setGain((1-chord.mute)*chord.equalizer);
		chord.on = true;
		chord.div.className = "chord-button chord-on";
	}, false);
	this.div.addEventListener('touchend', function(event){
		event.preventDefault();
		chord.gain.setGain(0);
		chord.on = false;
		chord.div.className = "chord-button";
	}, false);
	this.addSeparator();
	this.addSelector("tone", "changeTone", {"B":"B","A#":"A#","A":"A","G#":"G#","G":"G","F#":"F#","F":"F","E":"E","D#":"D#","D":"D","C#":"C#","C":"C"});
	this.addSeparator();
	this.addSelector("octave", "changeOctave", {"+5":5,"+4":4,"+3":3,"+2":2,"+1":1,"+0":0,"-1":-1,"-2":-2,"-3":-3,"-4":-4,"-5":-5});
	this.addSeparator();
	this.addSelector("type", "changeType", {"":"major", "m":"minor"});
	this.addSeparator();
	this.addSelector("shape", "changeShape", {"-":"square", "/":"sawtooth", "^":"triangle", "~":"sine"});
	this.addSeparator();
	this.addSelector("mute", "changeMute", {"*1":0,"*0.9":0.1,"*0.8":0.2,"*0.7":0.3,"*0.6":0.4,"*0.5":0.5,"*0.4":0.6,"*0.3":0.7,"*0.2":0.8,"*0.1":0.9,"*0":1});
	this.addSeparator();
	var appendButton = document.createElement("DIV");
	appendButton.className = "chord-append";
	appendButton.appendChild(document.createTextNode("+"));
	this.whole.appendChild(appendButton);
	appendButton.onmousedown = function(){
		chord.newChord();
	};
	appendButton.addEventListener('touchstart', function(event){
		event.preventDefault();
		chord.newChord();
	}, false);
	var deleteButton = document.createElement("DIV");
	deleteButton.className = "chord-delete";
	deleteButton.appendChild(document.createTextNode("-"));
	this.whole.appendChild(deleteButton);
	deleteButton.onmousedown = function(){
		chord.deleteChord();
	};
	deleteButton.addEventListener('touchstart', function(event){
		event.preventDefault();
		chord.deleteChord();
	}, false);
}
Chord.prototype.addSeparator = function(){
	var separator = document.createElement("DIV");
	separator.className = "chord-separator";
	this.whole.appendChild(separator);
}
Chord.prototype.setLabel = function(tone, octave, type){
	var label = tone;
	if (type === "minor"){
		label += "m";
	}
	this.label = label;
	this.div.firstChild.nodeValue = this.label;
}
Chord.prototype.setStyle = function(tone, octave, type){
	var style = "chord";
	if ({"A#": true, "C#": true, "D#": true, "F#": true, "G#": true}[tone]){
		style = "chord chord-sharp";
	}
	this.whole.className = style;
}
Chord.prototype.setEqualizer = function(tone, octave, type, shape){
	var equalizer = 1;
	var TONES = { "C": -900, "C#": -800, "D": -700, "D#": -600, "E": -500, "F": -400, "F#": -300, "G": -200, "G#": -100, "A": 0, "A#": 100, "B": 200};
	var detune = 0;
	detune += TONES[tone];
	detune += octave * 1200;
	var max = 1200 * 2;
	var min = -1200 * 2;
	if (detune > max){
		equalizer = 0;
	}
	else if (detune > min){
		equalizer = (max-detune)/(max - min);
	}
	var SHAPES = { "sine": 1, "triangle": 0.75, "sawtooth": 0.25, "square": 0.2};
	equalizer = equalizer * SHAPES[shape];
	this.equalizer = equalizer;
}
Chord.prototype.insertChord = function(tone, octave, type){
	return new Chord(this.audioContext, this.master, this.container, this.whole, tone, octave, type);
}
Chord.prototype.appendChord = function(tone, octave, type){
	return new Chord(this.audioContext, this.master, this.container, this.whole.nextSibling, tone, octave, type);
}
Chord.prototype.newChord = function(){
	this.appendChord(this.tone, this.octave, this.type);
}
Chord.prototype.refresh = function(){
	this.setLabel(this.tone, this.octave, this.type);
	this.setStyle(this.tone, this.octave, this.type);
	this.setEqualizer(this.tone, this.octave, this.type, this.shape);
	for (var index = 0; index < this.harmonics.length; index++){
		var harmonic = this.harmonics[index];
		var order = this.harmonics.length - index; 
		harmonic.setFrequency(this.tone, this.octave, this.type, order);
		harmonic.setDetune(this.tone, this.octave, this.type, order);
		harmonic.setShape(this.shape);
	}
}
Chord.prototype.changeChord = function(tone, octave, type){
	this.tone = tone;
	this.type = type;
	this.refresh();
}
Chord.prototype.changeTone = function(value){
	this.tone = value;
	this.refresh();
}
Chord.prototype.changeOctave = function(value){
	this.octave = parseInt(value, 10);
	this.refresh();
}
Chord.prototype.changeType = function(value){
	this.type = value;
	this.refresh();
}
Chord.prototype.changeShape = function(value){
	this.shape = value;
	this.refresh();
}
Chord.prototype.changeMute = function(value){
	this.mute = value;
}
Chord.prototype.deleteChord = function(){
	//todo release oscilator resources
}
Chord.prototype.addSelector = function(name, handler, options){
	var div = document.createElement("DIV");
	var selector = document.createElement("SELECT");
	selector.className = "chord-selector";
	for (var key in options){
		var option = document.createElement("OPTION");
		option.value = options[key];
		if (option.value == this[name]){
			option.selected = true;
		}
		option.appendChild(document.createTextNode(key));
		selector.appendChild(option);
	}
	div.appendChild(selector);
	this.whole.appendChild(div);
	var chord = this;
	selector.onchange = function(){
		chord[handler](selector.value);
	};
}
		</script end="Chord">
		<script start="Main">
window.AudioContext = window.AudioContext || window.webkitAudioContext;
var audioContext = new AudioContext();
var master = new Gain(audioContext);
master.setGain(0.1);
new Chord(audioContext, master, document.body, null, "C", 0, "minor");
/* //debug
new Chord(audioContext, master, document.body, null, "C#", 0, "minor");
new Chord(audioContext, master, document.body, null, "D", 0, "minor");
new Chord(audioContext, master, document.body, null, "D#", 0, "minor");
new Chord(audioContext, master, document.body, null, "E", 0, "minor");
new Chord(audioContext, master, document.body, null, "F", 0, "minor");
new Chord(audioContext, master, document.body, null, "F#", 0, "minor");
new Chord(audioContext, master, document.body, null, "G", 0, "minor");
new Chord(audioContext, master, document.body, null, "G#", 0, "minor");
new Chord(audioContext, master, document.body, null, "A", 0, "minor");
new Chord(audioContext, master, document.body, null, "A#", 0, "minor");
new Chord(audioContext, master, document.body, null, "B", 0, "minor");
new Chord(audioContext, master, document.body, null, "C", 1, "minor");
*/ //debug
		</script end="Main">
	</body>
</html>
