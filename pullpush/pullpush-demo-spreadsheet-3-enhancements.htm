<html>
<head>
<title>pullpush (Pull Push Functional Reactive Programming) demo: spreadsheet</title>
<script src="pullpush.js"></script>
<script src="pullpush-minimo-library.js"></script>
<script src="pullpush-minimo-framework.js"></script>
<style>.spreadsheet { width:100%; }</style>
<style>.spreadsheet-formula { width:100%; min-width: 500px}</style>
<style>.spreadsheet-value { width:100%; min-width: 200px; cursor: pointer; color: blue; background-color: #DDDD; }</style>
<!-- <style id="spreadsheet-formula">.spreadsheet-formula { display: none; }</style> -->
<style id="spreadsheet-test-passes">#A9 { background-color: green; color: white; }</style>
<style id="spreadsheet-test-fails">#A9 { background-color: red; color: white; }</style>
</head>
<body>
Spreadsheet with a predefined sample: PI 8 decimal digit recursive calculation using Viete's formula in the form PI=((2-(2+(2+(2+(...)**0.5)**0.5)**0.5)**0.5)**0.5)*2**k where integer k is determinded using 2 and 4 as PI lower and upper bounds
<br/>
<table class="spreadsheet">
	<tr><td></td><td>A</td><td>B</td><td>C</td><td>D</td><td>E</td><td>F</td><td>G</td><td>H</td><td>I</td></tr>
	<tr><td>1</td><td><input id="$A1" class="spreadsheet-formula" value="Math.round($A4*Math.pow(2,Math.floor(Math.log(4/$A2)/Math.log(2)))*$A2)/$A4"/><input id="A1" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$B1" class="spreadsheet-formula"/><input id="B1" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$C1" class="spreadsheet-formula"/><input id="C1" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$D1" class="spreadsheet-formula"/><input id="D1" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$E1" class="spreadsheet-formula"/><input id="E1" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$F1" class="spreadsheet-formula"/><input id="F1" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$G1" class="spreadsheet-formula"/><input id="G1" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$H1" class="spreadsheet-formula"/><input id="H1" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$I1" class="spreadsheet-formula"/><input id="I1" class="spreadsheet-value" readonly="readonly"/></td></tr>
	<tr><td>2</td><td><input id="$A2" class="spreadsheet-formula" value="Math.sqrt(2-$A3)"/><input id="A2" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$B2" class="spreadsheet-formula"/><input id="B2" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$C2" class="spreadsheet-formula"/><input id="C2" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$D2" class="spreadsheet-formula"/><input id="D2" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$E2" class="spreadsheet-formula"/><input id="E2" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$F2" class="spreadsheet-formula"/><input id="F2" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$G2" class="spreadsheet-formula"/><input id="G2" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$H2" class="spreadsheet-formula"/><input id="H2" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$I2" class="spreadsheet-formula"/><input id="I2" class="spreadsheet-value" readonly="readonly"/></td></tr>
	<tr><td>3</td><td><input id="$A3" class="spreadsheet-formula" value="$A3>2-$A5?$A3:Math.sqrt(2+$A3)"/><input id="A3" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$B3" class="spreadsheet-formula"/><input id="B3" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$C3" class="spreadsheet-formula"/><input id="C3" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$D3" class="spreadsheet-formula"/><input id="D3" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$E3" class="spreadsheet-formula"/><input id="E3" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$F3" class="spreadsheet-formula"/><input id="F3" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$G3" class="spreadsheet-formula"/><input id="G3" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$H3" class="spreadsheet-formula"/><input id="H3" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$I3" class="spreadsheet-formula"/><input id="I3" class="spreadsheet-value" readonly="readonly"/></td></tr>
	<tr><td>4</td><td><input id="$A4" class="spreadsheet-formula" value="1/$A5"/><input id="A4" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$B4" class="spreadsheet-formula"/><input id="B4" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$C4" class="spreadsheet-formula"/><input id="C4" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$D4" class="spreadsheet-formula"/><input id="D4" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$E4" class="spreadsheet-formula"/><input id="E4" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$F4" class="spreadsheet-formula"/><input id="F4" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$G4" class="spreadsheet-formula"/><input id="G4" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$H4" class="spreadsheet-formula"/><input id="H4" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$I4" class="spreadsheet-formula"/><input id="I4" class="spreadsheet-value" readonly="readonly"/></td></tr>
	<tr><td>5</td><td><input id="$A5" class="spreadsheet-formula" value="0.00000001"/><input id="A5" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$B5" class="spreadsheet-formula"/><input id="B5" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$C5" class="spreadsheet-formula"/><input id="C5" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$D5" class="spreadsheet-formula"/><input id="D5" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$E5" class="spreadsheet-formula"/><input id="E5" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$F5" class="spreadsheet-formula"/><input id="F5" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$G5" class="spreadsheet-formula"/><input id="G5" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$H5" class="spreadsheet-formula"/><input id="H5" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$I5" class="spreadsheet-formula"/><input id="I5" class="spreadsheet-value" readonly="readonly"/></td></tr>
	<tr><td>6</td><td><input id="$A6" class="spreadsheet-formula" value="$A1-Math.PI"/><input id="A6" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$B6" class="spreadsheet-formula"/><input id="B6" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$C6" class="spreadsheet-formula"/><input id="C6" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$D6" class="spreadsheet-formula"/><input id="D6" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$E6" class="spreadsheet-formula"/><input id="E6" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$F6" class="spreadsheet-formula"/><input id="F6" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$G6" class="spreadsheet-formula"/><input id="G6" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$H6" class="spreadsheet-formula"/><input id="H6" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$I6" class="spreadsheet-formula"/><input id="I6" class="spreadsheet-value" readonly="readonly"/></td></tr>
	<tr><td>7</td><td><input id="$A7" class="spreadsheet-formula"/><input id="A7" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$B7" class="spreadsheet-formula"/><input id="B7" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$C7" class="spreadsheet-formula"/><input id="C7" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$D7" class="spreadsheet-formula"/><input id="D7" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$E7" class="spreadsheet-formula"/><input id="E7" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$F7" class="spreadsheet-formula"/><input id="F7" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$G7" class="spreadsheet-formula"/><input id="G7" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$H7" class="spreadsheet-formula"/><input id="H7" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$I7" class="spreadsheet-formula"/><input id="I7" class="spreadsheet-value" readonly="readonly"/></td></tr>
	<tr><td>8</td><td><input id="$A8" class="spreadsheet-formula"/><input id="A8" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$B8" class="spreadsheet-formula"/><input id="B8" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$C8" class="spreadsheet-formula"/><input id="C8" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$D8" class="spreadsheet-formula"/><input id="D8" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$E8" class="spreadsheet-formula"/><input id="E8" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$F8" class="spreadsheet-formula"/><input id="F8" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$G8" class="spreadsheet-formula"/><input id="G8" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$H8" class="spreadsheet-formula"/><input id="H8" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$I8" class="spreadsheet-formula"/><input id="I8" class="spreadsheet-value" readonly="readonly"/></td></tr>
	<tr><td>9</td><td><input id="$A9" class="spreadsheet-formula" value="$A5>$A6?'TEST: PASSES':'TEST: FAILS'"/><input id="A9" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$B9" class="spreadsheet-formula"/><input id="B9" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$C9" class="spreadsheet-formula"/><input id="C9" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$D9" class="spreadsheet-formula"/><input id="D9" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$E9" class="spreadsheet-formula"/><input id="E9" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$F9" class="spreadsheet-formula"/><input id="F9" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$G9" class="spreadsheet-formula"/><input id="G9" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$H9" class="spreadsheet-formula"/><input id="H9" class="spreadsheet-value" readonly="readonly"/></td><td><input id="$I9" class="spreadsheet-formula"/><input id="I9" class="spreadsheet-value" readonly="readonly"/></td></tr>
</table>
<script>
function spreadsheet(sink){
	let rows = [1, 2, 3, 4, 5, 6, 7, 8, 9];
	let columns = ["A", "B", "C", "D", "E", "F", "G", "H", "I"];
	let cells = [].concat(...columns.map(column => rows.map(row => column + row))); // "A1", "A2"..., "B1", "B2"...
	function formulaRecursion(id, formula){
		return formula.indexOf("$" + id) >= 0;
	}
	function formulaReplacement(match, p1, offset){
		return '(Number(pullpush(sink("' + p1 + ":" + offset + '"), input("' + p1 + '"))))';
	}
	function formulaSubstitution(formula){
		let substitution = formula.replace(/\$(..)/, formulaReplacement);
		if(substitution.length === formula.length){
			return substitution;
		}
		return formulaSubstitution(substitution);
	}
	function formulaEvaluation(sink, id){
		let formula = pullpush(sink, input("$" + id));
		let delay = formulaRecursion(id, formula)? 10: 0; // slowdown recursive formulas (to let other cells update)
		let substitution = formulaSubstitution(formula);
		try{
			let evaluation = substitution === ""? "": eval(substitution);
			return pullpush(sink, input(id), evaluation, delay);
		}
		catch(exception){
			console.log("spreadsheet error in $" + id + ": " + formula);
		}
		return pullpush(sink, formulaError, id, formula);
	}
	function formulaError(sink, id, formula){
		return pullpush(sink, input(id), "formula error: " + formula, 0);
	}
	function formulaValues(sink, id){
		return cells.reduce(function(unused, id){
			return pullpush(sink(id), formulaEvaluation, id);
		}, undefined);
	}
	function formulaTest(sink){
		let test = pullpush(sink, input("A9"));
		let passes = (test === "TEST: PASSES");
		return pullpush(sink, disabled("spreadsheet-test-fails"), passes, 0);
	}
	return pullpush(sink, formulaTest) && false ||
		pullpush(sink, formulaValues);
}
pullpush(sink("demo"), spreadsheet);
</script>
</body>
</html>
